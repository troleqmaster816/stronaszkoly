openapi: 3.1.0
info:
  title: School Timetable & Attendance API
  version: 1.0.0-draft
  contact:
    name: Szkola API Maintainers
    url: https://szkola.tkch.eu
  description: |
    Draft of a developer-friendly API for timetable browsing, attendance tracking,
    remote approvals, and admin overrides. Uses resource-oriented endpoints,
    standard HTTP semantics, and consistent error handling.
servers:
  - url: https://api.example.com
  - url: http://localhost:8787
tags:
  - name: Health
    description: Service health and readiness endpoints.
  - name: Users
    description: Endpoints for current user session identity.
  - name: Auth
    description: Session-based authentication endpoints.
  - name: Timetable
    description: Timetable dictionaries and lesson schedule endpoints.
  - name: Attendance
    description: Attendance state, entries, plans, and summaries.
  - name: Approvals
    description: One-time token approval workflow endpoints.
  - name: Overrides
    description: Subject and teacher name override management.
  - name: Jobs
    description: Asynchronous job execution and status endpoints.
  - name: Maintenance
    description: Administrative maintenance endpoints for timetable data.
  - name: ApiKeys
    description: API key metadata and rotation endpoints.
security:
  - BearerAuth: []
  - CookieAuth: []
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: API-Key
    CookieAuth:
      type: apiKey
      in: cookie
      name: auth
  parameters:
    FromDate:
      name: from
      in: query
      description: Inclusive ISO date (YYYY-MM-DD)
      required: false
      schema: { type: string, format: date }
    ToDate:
      name: to
      in: query
      description: Inclusive ISO date (YYYY-MM-DD)
      required: false
      schema: { type: string, format: date }
    Cursor:
      name: cursor
      in: query
      description: Cursor for keyset pagination
      required: false
      schema: { type: string }
    Limit:
      name: limit
      in: query
      description: Page size (max 200)
      required: false
      schema: { type: integer, minimum: 1, maximum: 200, default: 50 }
    CsrfToken:
      name: X-CSRF-Token
      in: header
      required: false
      schema: { type: string }
      description: Required when using cookie authentication. Must match csrf cookie value.
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: false
      schema: { type: string }
      description: Optional key to safely retry a non-idempotent request.
  headers:
    XRequestId:
      description: Stable request id for tracing.
      schema: { type: string }
    RateLimitLimit:
      description: Maximum number of requests allowed in the current window.
      schema: { type: integer }
    RateLimitRemaining:
      description: Remaining requests in the current window.
      schema: { type: integer }
    RateLimitReset:
      description: Seconds until the rate-limit window resets.
      schema: { type: integer }
  responses:
    Problem400:
      description: Bad request
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
    Problem401:
      description: Unauthorized
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
    Problem403:
      description: Forbidden
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
    Problem404:
      description: Not found
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
    Problem409:
      description: Conflict
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
    Problem410:
      description: Gone
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
    Problem429:
      description: Too many requests
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
    Problem500:
      description: Internal server error
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
  schemas:
    Problem:
      type: object
      description: RFC 7807-like problem details.
      properties:
        type: { type: string, description: Unique error identifier URI or code }
        title: { type: string }
        status: { type: integer }
        detail: { type: string }
        instance: { type: string }
        code: { type: string, description: Domain-specific, machine-readable code }
        fields:
          type: array
          description: Field-level validation errors
          items:
            type: object
            properties:
              path: { type: string }
              message: { type: string }
    User:
      type: object
      properties:
        id: { type: string }
        username: { type: string }
    Ref:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
      required: [id, name]
    Lesson:
      type: object
      properties:
        day: { type: string }
        lesson_num: { type: string }
        time: { type: string }
        subject: { type: string }
        teacher: { anyOf: [ { $ref: '#/components/schemas/Ref' }, { type: 'null' } ] }
        group:   { anyOf: [ { $ref: '#/components/schemas/Ref' }, { type: 'null' } ] }
        room:    { anyOf: [ { $ref: '#/components/schemas/Ref' }, { type: 'null' } ] }
      required: [day, lesson_num, time, subject]
    AttendanceEntry:
      type: object
      properties:
        id: { type: string, description: Stable entry id }
        date: { type: string, format: date }
        dayName: { type: string }
        slot: { type: string }
        subjectKey: { type: string }
        subjectLabel: { type: string }
        present: { type: boolean }
        teacherId: { type: string, nullable: true }
        classId: { type: string, nullable: true }
        roomId: { type: string, nullable: true }
      required: [id, date, subjectKey, subjectLabel, present]
    AttendanceSummary:
      type: object
      properties:
        total: { type: integer }
        present: { type: integer }
        percent: { type: number }
        needToReach50: { type: integer }
        canSkipAndKeep50: { type: integer }
    Overrides:
      type: object
      properties:
        subjectOverrides:
          type: object
          additionalProperties: { type: string }
        teacherNameOverrides:
          type: object
          additionalProperties: { type: string }
      required: [subjectOverrides, teacherNameOverrides]
    ApprovalToken:
      type: object
      properties:
        token: { type: string }
        url: { type: string }
        expiresAt: { type: string, format: date-time }
      required: [token, url, expiresAt]

    BackupEntry:
      type: object
      properties:
        filename: { type: string }
        size: { type: integer }
        mtime: { type: string, format: date-time }
      required: [filename, size, mtime]

    UserMeData:
      type: object
      properties:
        authenticated: { type: boolean }
        user: { anyOf: [ { $ref: '#/components/schemas/User' }, { type: 'null' } ] }
      required: [authenticated]

    ApiKeyMeta:
      type: object
      properties:
        hasKey: { type: boolean }
        preview: { type: string, nullable: true }
        createdAt: { type: integer, nullable: true }
        lastUsedAt: { type: integer, nullable: true }
        format: { type: string, enum: [structured], nullable: true }
        requiresRotation: { type: boolean }
      required: [hasKey]

    ApiKeyRotateData:
      type: object
      properties:
        apiKey: { type: string }
        preview: { type: string }
        createdAt: { type: integer }
        format: { type: string, enum: [structured] }
      required: [apiKey, preview, createdAt, format]

    JobStatus:
      type: object
      properties:
        id: { type: string }
        kind: { type: string, nullable: true }
        status: { type: string, enum: [queued, running, succeeded, failed, timeout] }
        createdAt: { type: string, format: date-time }
        startedAt: { type: string, format: date-time, nullable: true }
        finishedAt: { type: string, format: date-time, nullable: true }
        error: { type: string, nullable: true }
      required: [id, status]

    AttendanceState:
      type: object
      description: Full per-user attendance state (used by GET/PUT /v1/attendance)
      properties:
        subjects:
          type: array
          items: { type: object, properties: { key: { type: string }, label: { type: string } }, required: [key, label] }
        plans:
          type: array
          items:
            type: object
            properties:
              id: { type: string }
              name: { type: string }
              days:
                type: object
                additionalProperties:
                  type: object
                  properties:
                    items:
                      type: array
                      items:
                        type: object
                        properties:
                          slotHint: { type: string, nullable: true }
                          subjectKey: { type: string }
                          subjectLabel: { type: string }
            required: [id, name, days]
        byDate:
          type: object
          additionalProperties:
            type: array
            items:
              type: object
              properties:
                id: { type: string }
                date: { type: string, format: date }
                dayName: { type: string }
                slot: { type: string }
                subjectKey: { type: string }
                subjectLabel: { type: string }
                present: { type: boolean }
              required: [id, date, subjectKey, subjectLabel, present]
        version: { type: integer, nullable: true }
        updatedAt: { type: integer, nullable: true }

paths:
  /v1/health:
    get:
      security: []
      summary: Health check
      operationId: getHealth
      tags: [Health]
      description: Returns service health and basic readiness status.
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      status: { type: string }
                    required: [status]
                required: [ok, data]

  /v1/users/me:
    get:
      security: []
      summary: Returns the current user if authenticated
      operationId: getCurrentUser
      tags: [Users]
      description: Returns authentication state and current user profile when a valid session exists.
      responses:
        '200':
          description: Current user
          headers:
            X-Request-Id: { $ref: '#/components/headers/XRequestId' }
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data: { $ref: '#/components/schemas/UserMeData' }
                required: [ok, data]

  /v1/login:
    post:
      security: []
      summary: Log in and set a session cookie (for web panel)
      operationId: loginUser
      tags: [Auth]
      description: Authenticates a user and issues the auth session cookie.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username: { type: string }
                password: { type: string }
              required: [username, password]
      responses:
        '200':
          description: Logged in
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      authenticated: { type: boolean }
                    required: [authenticated]
                required: [ok, data]
        '401':
          $ref: '#/components/responses/Problem401'
        '429':
          $ref: '#/components/responses/Problem429'

  /v1/logout:
    post:
      security: []
      summary: Log out and clear the session cookie
      operationId: logoutUser
      tags: [Auth]
      description: Revokes the current session and clears the auth cookie.
      responses:
        '200':
          description: Logged out
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      loggedOut: { type: boolean }
                    required: [loggedOut]
                required: [ok, data]

  /v1/register:
    post:
      security: []
      summary: Register a new user and create a session (when registration is enabled)
      operationId: registerUser
      tags: [Auth]
      description: Creates a new user account (when enabled) and starts an authenticated session.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username: { type: string }
                password: { type: string }
              required: [username, password]
      responses:
        '200':
          description: Registered
          headers:
            RateLimit-Limit: { $ref: '#/components/headers/RateLimitLimit' }
            RateLimit-Remaining: { $ref: '#/components/headers/RateLimitRemaining' }
            RateLimit-Reset: { $ref: '#/components/headers/RateLimitReset' }
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      authenticated: { type: boolean }
                    required: [authenticated]
                required: [ok, data]
        '400':
          description: Invalid username or password
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }
        '403':
          description: Registration disabled
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }
        '409':
          description: User exists
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }
        '429':
          description: Too many registration attempts
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }
        '500':
          $ref: '#/components/responses/Problem500'
  /v1/teachers:
    get:
      security: []
      summary: List teachers
      operationId: listTeachers
      tags: [Timetable]
      description: Returns the teacher id-to-label dictionary from timetable data.
      responses:
        '200':
          description: Map of teacher id to label
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    additionalProperties: { type: string }
                required: [ok, data]
        '404':
          $ref: '#/components/responses/Problem404'

  /v1/classes:
    get:
      security: []
      summary: List classes
      operationId: listClasses
      tags: [Timetable]
      description: Returns the class id-to-label dictionary from timetable data.
      responses:
        '200':
          description: Map of class id to label
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    additionalProperties: { type: string }
                required: [ok, data]
        '404':
          $ref: '#/components/responses/Problem404'

  /v1/rooms:
    get:
      security: []
      summary: List rooms
      operationId: listRooms
      tags: [Timetable]
      description: Returns the room id-to-label dictionary from timetable data.
      responses:
        '200':
          description: Map of room id to label
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    additionalProperties: { type: string }
                required: [ok, data]
        '404':
          $ref: '#/components/responses/Problem404'

  /v1/teachers/{id}/timetable:
    get:
      security: []
      summary: Get a teacher's timetable
      operationId: getTeacherTimetable
      tags: [Timetable]
      description: Returns lessons for a teacher by canonical id or alias.
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, description: Canonical id (e.g., n12) or alias (e.g., initials like RM). Aliases may be ambiguous (409). }
      responses:
        '200':
          description: Lessons for the teacher
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      id: { type: string, description: Canonical id resolved from alias (if alias used) }
                      lessons:
                        type: array
                        items: { $ref: '#/components/schemas/Lesson' }
                    required: [id, lessons]
                required: [ok, data]
        '404':
          $ref: '#/components/responses/Problem404'
        '409':
          $ref: '#/components/responses/Problem409'

  /v1/classes/{id}/timetable:
    get:
      security: []
      summary: Get a class timetable
      operationId: getClassTimetable
      tags: [Timetable]
      description: Returns class lessons by canonical id or alias, with optional group filtering.
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, description: Canonical id (e.g., o5) or alias (e.g., 4TAI). Aliases may be ambiguous (409). }
        - name: group
          in: query
          required: false
          description: Group id or name (e.g., "2/2"). When provided, returns lessons for the whole class and that specific group, excluding other groups.
          schema: { type: string }
        - name: includeWhole
          in: query
          required: false
          description: Include whole-class lessons when filtering by group (default true)
          schema: { type: boolean, default: true }
      responses:
        '200':
          description: Lessons for the class
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      id: { type: string, description: Canonical id resolved from alias (if alias used) }
                      lessons:
                        type: array
                        items: { $ref: '#/components/schemas/Lesson' }
                    required: [id, lessons]
                required: [ok, data]
        '404':
          $ref: '#/components/responses/Problem404'
        '409':
          $ref: '#/components/responses/Problem409'

  /v1/rooms/{id}/timetable:
    get:
      security: []
      summary: Get a room timetable
      operationId: getRoomTimetable
      tags: [Timetable]
      description: Returns lessons scheduled in a room by canonical id or alias.
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, description: Canonical id (e.g., s36) or alias (e.g., room number 407). Aliases may be ambiguous (409). }
      responses:
        '200':
          description: Lessons for the room
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      id: { type: string, description: Canonical id resolved from alias (if alias used) }
                      lessons:
                        type: array
                        items: { $ref: '#/components/schemas/Lesson' }
                    required: [id, lessons]
                required: [ok, data]
        '404':
          $ref: '#/components/responses/Problem404'
        '409':
          $ref: '#/components/responses/Problem409'

  /v1/attendance/entries:
    get:
      summary: List attendance entries for the current user
      operationId: listAttendanceEntries
      tags: [Attendance]
      description: Lists attendance entries for the current user with filters and cursor pagination.
      parameters:
        - $ref: '#/components/parameters/FromDate'
        - $ref: '#/components/parameters/ToDate'
        - name: subjectKey
          in: query
          required: false
          schema: { type: string }
        - name: classId
          in: query
          required: false
          schema: { type: string }
        - name: teacherId
          in: query
          required: false
          schema: { type: string }
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Cursor'
      responses:
        '200':
          description: A page of entries
          headers:
            X-Request-Id: { $ref: '#/components/headers/XRequestId' }
            RateLimit-Limit: { $ref: '#/components/headers/RateLimitLimit' }
            RateLimit-Remaining: { $ref: '#/components/headers/RateLimitRemaining' }
            RateLimit-Reset: { $ref: '#/components/headers/RateLimitReset' }
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      entries:
                        type: array
                        items: { $ref: '#/components/schemas/AttendanceEntry' }
                      nextCursor:
                        type: string
                        nullable: true
                    required: [entries]
                required: [ok, data]
        '401':
          $ref: '#/components/responses/Problem401'
    patch:
      summary: Bulk update entries by id (set present true/false)
      operationId: patchAttendanceEntries
      tags: [Attendance]
      description: Bulk-updates selected attendance entries and supports optional optimistic concurrency via ifMatch.
      parameters:
        - $ref: '#/components/parameters/CsrfToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                updates:
                  type: array
                  items:
                    type: object
                    properties:
                      id: { type: string }
                      present: { type: boolean }
                      ifMatch: { type: string, description: Optional ETag to guard against lost updates }
                    required: [id, present]
              required: [updates]
      responses:
        '200':
          description: Update results
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      updated: { type: integer }
                    required: [updated]
                required: [ok, data]
        '400':
          $ref: '#/components/responses/Problem400'
        '401':
          $ref: '#/components/responses/Problem401'
        '403':
          $ref: '#/components/responses/Problem403'
        '409':
          $ref: '#/components/responses/Problem409'
        '500':
          $ref: '#/components/responses/Problem500'

  /v1/attendance:
    get:
      summary: Get full attendance state for the current user
      operationId: getAttendanceState
      tags: [Attendance]
      description: Returns the full attendance state for the authenticated user.
      responses:
        '200':
          description: Current state
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data: { $ref: '#/components/schemas/AttendanceState' }
                required: [ok, data]
        '401':
          $ref: '#/components/responses/Problem401'
    put:
      summary: Replace full attendance state for the current user
      operationId: replaceAttendanceState
      tags: [Attendance]
      description: Replaces the full attendance state for the authenticated user.
      parameters:
        - $ref: '#/components/parameters/CsrfToken'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AttendanceState' }
      responses:
        '200':
          description: Saved
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      saved: { type: boolean }
                    required: [saved]
                required: [ok, data]
        '400':
          $ref: '#/components/responses/Problem400'
        '401':
          $ref: '#/components/responses/Problem401'
        '403':
          $ref: '#/components/responses/Problem403'
        '500':
          $ref: '#/components/responses/Problem500'

  /v1/attendance/summary:
    get:
      summary: Summary stats for the current user
      operationId: getAttendanceSummary
      tags: [Attendance]
      description: Computes attendance totals and percentage in the selected date range and optional subject.
      parameters:
        - $ref: '#/components/parameters/FromDate'
        - $ref: '#/components/parameters/ToDate'
        - name: subjectKey
          in: query
          required: false
          schema: { type: string }
      responses:
        '200':
          description: Summary stats
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data: { $ref: '#/components/schemas/AttendanceSummary' }
                required: [ok, data]
        '401':
          $ref: '#/components/responses/Problem401'

  /v1/attendance/days/{dateISO}/present:
    post:
      summary: Set presence for all entries on a given day
      operationId: setDayPresence
      tags: [Attendance]
      description: Sets presence for all attendance entries on a single day.
      parameters:
        - name: dateISO
          in: path
          required: true
          schema: { type: string, format: date }
        - $ref: '#/components/parameters/CsrfToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                present: { type: boolean }
              required: [present]
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      updated: { type: integer }
                    required: [updated]
                required: [ok, data]
        '401':
          $ref: '#/components/responses/Problem401'
        '403':
          $ref: '#/components/responses/Problem403'
        '500':
          $ref: '#/components/responses/Problem500'

  /v1/attendance/plans:
    get:
      summary: List user lesson plans (FrekwencjaPage)
      operationId: listAttendancePlans
      tags: [Attendance]
      description: Returns saved attendance plans for the current user.
      responses:
        '200':
          description: Plans
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        id: { type: string }
                        name: { type: string }
                        days:
                          type: object
                          additionalProperties:
                            type: object
                            properties:
                              items:
                                type: array
                                items:
                                  type: object
                                  properties:
                                    slotHint: { type: string, nullable: true }
                                    subjectKey: { type: string }
                                    subjectLabel: { type: string }
                required: [ok, data]
        '401':
          $ref: '#/components/responses/Problem401'
      
  /v1/attendance/days/{dateISO}/apply-plan:
    post:
      summary: Fill a day from a saved plan and optionally set presence
      operationId: applyAttendancePlan
      tags: [Attendance]
      description: Creates day entries from a saved plan and optionally sets presence values.
      parameters:
        - name: dateISO
          in: path
          required: true
          schema: { type: string, format: date }
        - $ref: '#/components/parameters/CsrfToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                planId: { type: string }
                overwrite: { type: boolean, default: false }
                setPresent: { type: boolean, nullable: true, description: When provided, sets presence on created entries }
              required: [planId]
      responses:
        '200':
          description: Applied
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      created: { type: integer }
                      overwritten: { type: boolean }
                    required: [created, overwritten]
                required: [ok, data]
        '400':
          $ref: '#/components/responses/Problem400'
        '401':
          $ref: '#/components/responses/Problem401'
        '403':
          $ref: '#/components/responses/Problem403'
        '404':
          $ref: '#/components/responses/Problem404'
        '409':
          $ref: '#/components/responses/Problem409'
        '500':
          $ref: '#/components/responses/Problem500'

  /v1/approvals:
    post:
      security:
        - CookieAuth: []
      summary: Create a one-time approval token to update an entry
      operationId: createApprovalToken
      tags: [Approvals]
      description: Creates a one-time approval token for remote accept or deny flow.
      parameters:
        - $ref: '#/components/parameters/CsrfToken'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                action:
                  type: string
                  enum: [toggle, set]
                dateISO:
                  type: string
                  format: date
                entryId: { type: string }
                present:
                  type: boolean
                  description: Required when action = set
              required: [action, dateISO, entryId]
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data: { $ref: '#/components/schemas/ApprovalToken' }
                required: [ok, data]
        '400':
          $ref: '#/components/responses/Problem400'
        '401':
          $ref: '#/components/responses/Problem401'
        '403':
          $ref: '#/components/responses/Problem403'
        '500':
          $ref: '#/components/responses/Problem500'

  /v1/approvals/{token}:
    get:
      security: []
      summary: Get approval status
      operationId: getApprovalStatus
      tags: [Approvals]
      description: Returns current status and expiry metadata for an approval token.
      parameters:
        - name: token
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Approval status
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      status: { type: string, enum: [pending, accepted, denied, expired] }
                      createdAt: { type: string, format: date-time }
                      expiresAt: { type: string, format: date-time }
                    required: [status]
                required: [ok, data]
        '404':
          $ref: '#/components/responses/Problem404'
        '410':
          $ref: '#/components/responses/Problem410'
        '500':
          $ref: '#/components/responses/Problem500'
    post:
      security: []
      summary: Submit a decision for an approval token
      operationId: decideApproval
      tags: [Approvals]
      description: Applies accept or deny decision to a pending approval token.
      parameters:
        - name: token
          in: path
          required: true
          schema: { type: string }
        - $ref: '#/components/parameters/CsrfToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                decision: { type: string, enum: [accept, deny] }
              required: [decision]
      responses:
        '200':
          description: Decision accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      status: { type: string, enum: [accepted, denied] }
                    required: [status]
                required: [ok, data]
        '400':
          $ref: '#/components/responses/Problem400'
        '403':
          $ref: '#/components/responses/Problem403'
        '404':
          $ref: '#/components/responses/Problem404'
        '409':
          $ref: '#/components/responses/Problem409'
        '410':
          $ref: '#/components/responses/Problem410'
        '500':
          $ref: '#/components/responses/Problem500'

  /v1/overrides:
    get:
      summary: Read subject and teacher name overrides
      operationId: getOverrides
      tags: [Overrides]
      description: Returns subject and teacher name override maps.
      security: []
      responses:
        '200':
          description: Overrides
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data: { $ref: '#/components/schemas/Overrides' }
                required: [ok, data]
        '500':
          $ref: '#/components/responses/Problem500'
    put:
      security:
        - CookieAuth: []
      summary: Replace overrides (admin)
      operationId: replaceOverrides
      tags: [Overrides]
      description: Replaces override maps for subjects and teacher names (admin).
      parameters:
        - $ref: '#/components/parameters/CsrfToken'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/Overrides' }
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      saved: { type: boolean }
                    required: [saved]
                required: [ok, data]
        '403':
          description: Admin required
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }
        '401':
          $ref: '#/components/responses/Problem401'
        '500':
          $ref: '#/components/responses/Problem500'

  /v1/jobs/timetable-scrape:
    post:
      security:
        - CookieAuth: []
      summary: Start an async job to refresh timetable data (admin-only)
      operationId: startTimetableScrapeJob
      tags: [Jobs]
      description: Starts or reuses an asynchronous timetable scraping job (admin).
      parameters:
        - $ref: '#/components/parameters/CsrfToken'
      responses:
        '202':
          description: Job accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      jobId: { type: string }
                      statusUrl: { type: string }
                      status: { type: string, enum: [queued, running, succeeded, failed, timeout] }
                    required: [jobId, statusUrl, status]
                required: [ok, data]
        '403':
          description: Admin required
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }
        '401':
          $ref: '#/components/responses/Problem401'
        '500':
          $ref: '#/components/responses/Problem500'
  /v1/jobs/articles-scrape:
    post:
      security:
        - CookieAuth: []
      summary: Start an async job to refresh articles (admin-only)
      operationId: startArticlesScrapeJob
      tags: [Jobs]
      description: Starts or reuses an asynchronous article scraping job (admin).
      parameters:
        - $ref: '#/components/parameters/CsrfToken'
      responses:
        '202':
          description: Job accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      jobId: { type: string }
                      statusUrl: { type: string }
                      status: { type: string, enum: [queued, running, succeeded, failed, timeout] }
                    required: [jobId, statusUrl, status]
                required: [ok, data]
        '403':
          description: Admin required
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }
        '401':
          $ref: '#/components/responses/Problem401'
        '500':
          $ref: '#/components/responses/Problem500'
  /v1/jobs/{jobId}:
    get:
      security: []
      summary: Get job status
      operationId: getJobStatus
      tags: [Jobs]
      description: Returns current state and metadata for an asynchronous job.
      parameters:
        - name: jobId
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Job status
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data: { $ref: '#/components/schemas/JobStatus' }
                required: [ok, data]
        '404':
          $ref: '#/components/responses/Problem404'

  /v1/refresh:
    post:
      security:
        - CookieAuth: []
      summary: Synchronously refresh timetable data using the scraper (admin-only)
      operationId: refreshTimetableSync
      tags: [Maintenance]
      description: Runs synchronous timetable refresh and returns scraper result details (admin).
      parameters:
        - $ref: '#/components/parameters/CsrfToken'
      responses:
        '200':
          description: Scrape finished successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    nullable: true
                required: [ok, data]
        '409':
          description: Scraper already running
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }
        '401':
          $ref: '#/components/responses/Problem401'
        '429':
          $ref: '#/components/responses/Problem429'
        '403':
          description: Admin required
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }
        '500':
          description: Error during scraping
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }

  /v1/timetable/backups:
    get:
      security:
        - CookieAuth: []
      summary: List available timetable backups (admin-only)
      operationId: listTimetableBackups
      tags: [Maintenance]
      description: Lists available timetable backup files with size and timestamps (admin).
      responses:
        '200':
          description: Backups
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: array
                    items: { $ref: '#/components/schemas/BackupEntry' }
                required: [ok, data]
        '403':
          description: Admin required
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }
        '401':
          $ref: '#/components/responses/Problem401'
        '500':
          $ref: '#/components/responses/Problem500'

  /v1/timetable/restore:
    post:
      security:
        - CookieAuth: []
      summary: Restore timetable_data.json from a selected backup (admin-only)
      operationId: restoreTimetableBackup
      tags: [Maintenance]
      description: Restores timetable data from a selected backup file (admin).
      parameters:
        - $ref: '#/components/parameters/CsrfToken'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                filename: { type: string }
              required: [filename]
      responses:
        '200':
          description: Restored
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      restored: { type: boolean }
                    required: [restored]
                required: [ok, data]
        '400':
          description: Invalid filename
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }
        '403':
          description: Admin required
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }
        '401':
          $ref: '#/components/responses/Problem401'
        '404':
          description: Backup not found
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }
        '500':
          $ref: '#/components/responses/Problem500'

  /v1/apikey:
    get:
      security:
        - CookieAuth: []
      summary: Get metadata of current user's API key (or admin API key)
      operationId: getApiKeyMeta
      tags: [ApiKeys]
      description: Returns metadata of the current user API key without exposing the full secret.
      responses:
        '200':
          description: API key metadata
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data: { $ref: '#/components/schemas/ApiKeyMeta' }
                required: [ok, data]
        '401':
          $ref: '#/components/responses/Problem401'
        '404':
          $ref: '#/components/responses/Problem404'

  /v1/apikey/regenerate:
    post:
      security:
        - CookieAuth: []
      summary: Regenerate the API key for the current user (or admin)
      operationId: regenerateApiKey
      tags: [ApiKeys]
      description: Regenerates API key for the current user and invalidates the previous key.
      parameters:
        - $ref: '#/components/parameters/CsrfToken'
      responses:
        '200':
          description: New key
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data: { $ref: '#/components/schemas/ApiKeyRotateData' }
                required: [ok, data]
        '401':
          $ref: '#/components/responses/Problem401'
        '403':
          $ref: '#/components/responses/Problem403'
        '404':
          $ref: '#/components/responses/Problem404'
